<html>
  <head>
    <title>Deck Games</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
      body {
        font-size: 24pt;
        font-family: 'Arial', sans-serif;
        background-color: #1B5E20;
      }

      .bean {
        border: 2px solid #000;
        border-radius: 15px;
        background-color: #388E3C;
        margin-right: 10px;
        text-align: center;
      }

      .large {
        font-size: 48pt;
      }
      .other span {
        display: inline-block;
      }
      .other .name {
        width: 10%;
      }

      #others {
        border: 2px solid #000;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        background-color: #388E3C;
      }

      #playspace, #deckspace {
        border-left: 2px solid #000;
        border-right: 2px solid #000;
        background-color: #388E3C;
      }

      #playspace {
        padding-left: 35px;
      }

      #deckspace {
        border-bottom: 2px solid #000;
      }

      .player {
        background-color: #fff9c4;
        border-left: 2px solid #000;
        border-right: 2px solid #000;
        min-height: 78px;
        padding-right: 15px;
      }

      .player.end {
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
        border-bottom: 2px solid #000;
      }

      .player .name {
        padding-left: 5px;
      }

      .other {
        padding: 5px;
        border: 0px solid #1B5E20;
        border-bottom-width: 1px;
      }

      .other .deck {
        width: 10%;
      }
      .other .hand {
        width: 10%;
      }

      .wallet {
        float: right;
      }

      .deck::before {
        content: '\1F0A0';
      }
      .hand::before {
        content: '\270A';
        margin-right: 10px;
      }
      .discard::before {
        content: '\1F0DF';
      }

      .card {
        border: solid black;
        background-color: white;
        border-top-left-radius: 20px;
        padding-left: 5px;
        padding-right: 25px;
        margin-left: -30;
      }

      .card:last-child {
        padding-right: 5px;
      }

    </style>
  </head>
  <body>
    <div id='start' class='bean'>
      <h1>Deck Games</h1>
      <p>
        <a href='#' class='change-state' data-dest='#join-game'>Join Game</a>
      </p>
      <p>
        or
      </p>
      <p>
        <a href='#' class='change-state' data-dest='#start-game'>Start a New Game</a>
      </p>
    </div>
    <div id='join-game' class='bean' style='display: none'>
      <h2>Join a Game</h2>
      <p>
          <input type='text' placeholder='Your Name' class='name'></input>
      </p>
      <p>
          <input type='text' placeholder='Game Code' class='game-code'></input>
      </p>
      <p>
        <button>Join Game</button>
      </p>
      <p>
        Actually, I want to <a href='#' class='change-state' data-dest='#start-game'>Start a New Game</a>
      </p>
    </div>
    <div id='start-game' class='bean' style='display: none'>
      <h2>Start a Game</h2>
      <p>
          <input type='text' placeholder='Your Name' class='name'></input>
      </p>
      <p>
        <select class='deck-list'></select>
      </p>
      <p>
        <button>Start Game</button>
      </p>
      <p>
        Actually, I want to <a href='#' class='change-state' data-dest='#join-game'>Join a Game</a>
      </p>
    </div>
    <div id='others' style='display: none'>
    </div>
    <div id='playspace' class='large' style='display: none'>
    </div>
    <div id='deckspace' style='display: none'>
      <span class='deck large'></span>
      <span class='discard large'></span>
    </div>
    <div class='player' style='display: none'>
      <div class='name'></div>
      <span class='deck large'></span>
    </div>
    <div class='player' style='display: none'>
      <span class='revealed wallet large'>
      </span>
    </div>
    <div class='player end' style='display: none'>
      <span class='wallet hand large'>
      </span>
    </div>
    <div id='leader-lobby' class='bean' style='display: none'>
      <h1>Game Lobby</h1>
      <p>
        You have created a game. Please share this token:
      </p>
      <h2 class='token-holder'></h2>
      <p>Current Players:</p>
      <ul class='player-list'></ul>
      <button>Start Game</button>
    </div>
    <div id='player-lobby' class='bean' style='display: none'>
      <h1>Game Lobby</h1>
      <p>
        You have joined this game.
      </p>
      <p>Current Players:</p>
      <ul class='player-list'></ul>
      <p>Please wait for the leader to start the game.</p>
    </div>
  </body>
  <script>
  $(document).ready(function() {
    function card_html(card) {
      return `<span class='card' style='color: ${card.color};' data-text="${card.text}">${card.name}</span>`
    }
    function other_player_html(player) {
      return `<div class='other'>
        <span class='name'>${player.name}</span>
        <span class='deck'>${player.deck_size}</span>
        <span class='hand'>${player.hand_size}</span>
        <span class='wallet'>
          ${ player.revealed.map(card_html) }
        </span>
      </div>`;
    }
    function parseRawState(rawState, lastState) {
      var result = JSON.parse(rawState);
      if (result.state == 'waiting') {
        $('.player-list').html(result.players.map(function(p) {
          var name = p;
          if (p == result.leader) {
            name = p + "&nbsp;&#x265a;"
          }
          return `<li>${name}</li>`
        }).join(''));
      }
      if (result.state == 'playing' && lastState != 'playing') {
        $('.bean').hide();
        $('#others').show();
        $('#deckspace').show();
        $('#playspace').show();
        $('.player').show();
      }
      if (result.state == 'playing') {
        var player = result['player'];
        var other_players = result['other_players'];
        var game_cards = result['game_cards'];

        $('#others').html(other_players.map(other_player_html).join(''));

        console.log(game_cards);
        $('#deckspace .deck').html(game_cards.deck_size);
        $('#deckspace .discard').html(game_cards.discard.length);
        $('#playspace').html(game_cards.revealed.map(card_html).join(''));

        console.log(player);
        $('.player .name').html(player.name);
        $('.player .deck').html(player.deck_size);
        $('.player .revealed').html(player.revealed.map(card_html).join(''));
        $('.player .hand').html(player.hand.map(card_html).join(''));
      }
      return result;
    };
    function ping(playerCode, gameToken, lastState) {
      $.get(`/games/${gameToken}/ping/${playerCode}`, function(rawResult) {
        var result = parseRawState(rawResult, lastState);
        setTimeout(function() { ping(playerCode, gameToken, result.state); }, 1000);
      });
    };
    $.get('/decks', function(data) {
      JSON.parse(data).forEach(item => $('.deck-list').append(`<option value="${item}">${item}</option>`));
    });
    $('a.change-state').click(function() {
      var destination = $(this).data('dest');
      $(this).closest('.bean').hide();
      $(destination).show();
    });
    $('#join-game button').click(function() {
      var playerName = $('#join-game .name').val();
      var token = $('#join-game .game-code').val();
      $.post(`/games/${token}/join/${playerName}`, function(rawResult) {
        var result = JSON.parse(rawResult);
        // TODO: check for invalid token
        playerCode = result.code;
        result.players.forEach(p => $('#player-lobby .player-list').append(`<li>${p}</li>`));
        $('#join-game').hide();
        $('#player-lobby').show();
        setTimeout(function() { ping(playerCode, token, 'loading'); }, 1000);
      });
    });
    $('#start-game button').click(function() {
      var playerName = $('#start-game .name').val();
      var deckName = $('#start-game .deck-list').val();
      $.post(`/games/create/${deckName}/${playerName}`, function(rawResult) {
        var result = JSON.parse(rawResult);
        // TODO: check for invalid deck
        playerCode = result.code;
        gameToken = result.token;
        $('#start-game').hide();
        $('#leader-lobby').show();
        $('#leader-lobby .token-holder').text(gameToken);
        setTimeout(function() { ping(playerCode, gameToken, 'loading'); }, 1000);
        $('#leader-lobby button').click(function() {
          $.post(`/games/${gameToken}/start/${playerCode}`, function(rawResult) {
            parseRawState(rawResult, 'waiting');
          });
        });
      });
    });
  });
  </script>
</html>
